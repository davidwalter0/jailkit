#Copyright (c) 2003, 2004, 2005, 2006, Olivier Sessink
#All rights reserved.
#
#Redistribution and use in source and binary forms, with or without
#modification, are permitted provided that the following conditions 
#are met:
#  * Redistributions of source code must retain the above copyright 
#    notice, this list of conditions and the following disclaimer.
#  * Redistributions in binary form must reproduce the above 
#    copyright notice, this list of conditions and the following 
#    disclaimer in the documentation and/or other materials provided 
#    with the distribution.
#  * The names of its contributors may not be used to endorse or 
#    promote products derived from this software without specific 
#    prior written permission.
#
#THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 
#"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT 
#LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
#FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE 
#COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, 
#INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
#BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
#LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
#CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT 
#LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN 
#ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
#POSSIBILITY OF SUCH DAMAGE.
#

INSTALL = @INSTALL@
PACKAGE = @PACKAGE@
prefix = @prefix@
sysconfdir = @sysconfdir@
INIPREFIX = ${sysconfdir}/jailkit
PYTHONPATH = @PYTHONPATH@

PYLIBDIR=${prefix}/share/${PACKAGE}

jk_lib.pyc: jk_lib.py
	python -c "import py_compile;py_compile.compile('jk_lib.py')"

jk_init: jk_init.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_init.in > jk_init

jk_check: jk_check.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_check.in > jk_check

jk_cp: jk_cp.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_cp.in > jk_cp

jk_list: jk_list.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_list.in > jk_list

jk_addjailuser: jk_addjailuser.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_addjailuser.in > jk_addjailuser

jk_jailuser: jk_jailuser.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_jailuser.in > jk_jailuser

jk_update: jk_update.in
	sed -e "s!INIPREFIX='/etc/jailkit'!INIPREFIX='${INIPREFIX}'!" -e "s!LIBDIR='[a-z/]*'!LIBDIR='${PYLIBDIR}'!" -e "s:#!/usr/bin/python:#!$(PYTHONPATH):" < jk_update.in > jk_update


jailkit: jk_lib.pyc jk_cp jk_init jk_check jk_addjailuser jk_jailuser jk_list jk_update 

all: jailkit

install: jailkit
	${INSTALL} -d -m 755 ${prefix}/sbin
	${INSTALL} -d -m 755 ${PYLIBDIR}
	${INSTALL} -g 0 -o root -m 0644 jk_lib.py ${PYLIBDIR}/
	${INSTALL} -g 0 -o root -m 0644 jk_lib.pyc ${PYLIBDIR}/
	${INSTALL} -g 0 -o root -m 0755 jk_init ${prefix}/sbin
	${INSTALL} -g 0 -o root -m 0755 jk_check ${prefix}/sbin
	${INSTALL} -g 0 -o root -m 0755 jk_cp ${prefix}/sbin
	${INSTALL} -g 0 -o root -m 0755 jk_addjailuser ${prefix}/sbin
	${INSTALL} -g 0 -o root -m 0755 jk_jailuser ${prefix}/sbin
	${INSTALL} -g 0 -o root -m 0755 jk_list ${prefix}/sbin
	${INSTALL} -g 0 -o root -m 0755 jk_update ${prefix}/sbin

uninstall:
	rm -f ${prefix}/sbin/jk_cp
	rm -f ${prefix}/sbin/jk_init
	rm -f ${prefix}/sbin/jk_check
	rm -f ${prefix}/sbin/jk_addjailuser
	rm -f ${prefix}/sbin/jk_jailuser
	rm -f ${prefix}/sbin/jk_list
	rm -f ${prefix}/sbin/jk_update
	rm -f ${PYLIBDIR}/jk_lib.*
	- rmdir --ignore-fail-on-non-empty ${PYLIBDIR}

clean:
	rm -f *~
	rm -f jk_lib.pyc jk_cp jk_init jk_check jk_addjailuser jk_jailuser jk_list jk_update

distclean: clean
	rm -f Makefile
